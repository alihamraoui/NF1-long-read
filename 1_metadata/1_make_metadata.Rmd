---
title: "NF1 long-read"
subtitle: "Set metadata"
author: "Ali Hamraoui & Audrey Onfroy"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: show
    code_download: true
    toc: true
    toc_float: true
    number_sections: false
---

<style>
body {
text-align: justify}
</style>

<!-- Automatically computes and prints in the output the running time for any code chunk -->
```{r, echo=FALSE}
# https://github.com/rstudio/rmarkdown/issues/1453
hooks = knitr::knit_hooks$get()
hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold_", type)]])) return(res)
    
    paste0(
      "<details><summary>", "show", "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}
knitr::knit_hooks$set(
  output = hook_foldable("output"),
  plot = hook_foldable("plot")
)
```

<!-- Set default parameters for all chunks -->
```{r, setup, include = FALSE}
set.seed(1337L)
knitr::opts_chunk$set(echo = TRUE, # display code
                      # display chunk output
                      message = FALSE,
                      warning = FALSE,
                      fold_output = FALSE, # for sessionInfo()
                      fold_plot = FALSE,
                      
                      # figure settings
                      fig.align = 'center',
                      fig.width = 20,
                      fig.height = 15)
```


This file is used to generate :

* **sample_info** : dataframe containing sample names, sample path, custom colors...
* **color_markers** : named list to give custom colors to cell types
* **cell_markers** : named list containing markers for each cell type

```{r library, time_it = TRUE}
library(dplyr)
library(patchwork)
library(ggplot2)

.libPaths()
```


# Preparation

In this section, we set the global settings of the analysis. We will store data there :

```{r out_dir}
save_name = "nf1"
out_dir = "."
```

# Sample info

```{r sample_info_flfl}
sample_info = data.frame(
  project_name = c("2020_23", "2020_26"),
  genotype = c("flfl", "nude"),
  tumor_type = c("dyNF", "MPNST"),
  gender = c("M", "F"),
  color = c("#1B9E77", "#D95F02"), # from RColorBrewer::brewer.pal("Dark2", n = 3)
  origin = "here",
  sample_identifier = c("donor", "recipient"),
  stringsAsFactors = FALSE) %>%
  dplyr::mutate(sample_type = paste0(genotype, "_", tumor_type)) %>%
  dplyr::mutate(unique_id = data.table::rowid(sample_type)) %>%
  dplyr::select(project_name,  genotype, tumor_type, gender,
                origin, sample_identifier, sample_type, color) %>%
  dplyr::mutate(across(!color, function(x) factor(x, levels = unique(x))))

sample_info
```


It is possible to make confusion between colors ?

```{r custom_palette_pie, fig.width = 8, fig.height = 8}
graphics::pie(rep(1, nrow(sample_info)),
              col = sample_info$color,
              labels = sample_info$project_name)
```

We save it :

```{r save_sample_info}
saveRDS(sample_info, file = paste0(out_dir, "/", save_name, "_sample_info.rds"))
```


# Cell types

We define markers for each population of interest :

```{r cell_markers, class.source = "fold-hide"}
cell_markers = list(
  "tumor cells" = c("Ank3", "Plp1", "Nav2", "Col18a1", "Postn", "Sox4", "Serpine2",
                    "Gpm6b", "Cald1", "Pdgfa", "Timp3", "Aatk", "Dst", "Fbln2", 
                    "Lgi4", "Serpinh1", "Nr2f2", "Itgb8", "Col5a2", "Ptprz1", "Lama4", 
                    "Gjc3", "Tenm3", "Col1a2", "Zfp536", "Col16a1", "Dlgap1", "Tead1", 
                    "Stard13", "Col27a1", "Cdh19", "Sox10", "Tanc2", "Erbb3", "Pdzd2", 
                    "Col1a1", "Col3a1", "Sparc", "Pdlim4", "Emp1", "Dock7", "Klf9", 
                    "Hs2st1", "Nedd4", "Gas7", "Utrn", "Specc1", "Frmd4a", "Tpm1", 
                    "Dusp6", "Gas1", "Cxcl12", "Pdgfrb", "Col6a1", "Htra1", "Loxl1", 
                    "Mast4", "Slit2", "Col4a2", "Pcolce", "Cpe", "Dkk2", "Cav1", 
                    "Prss23", "Tead1", "Gja1", "Wwtr1", "Aebp1", "Nrep", "Nid1", 
                    "Col18a1", "Itgbl1", "Zfhx4", "Fbn1", "Pcdh19", "Ddr2", "Sdc2", 
                    "Mxra7", "Cnn3", "Col16a1", "Ltbp1", "Foxg1", "Ltbp4", "Lhfp", 
                    "Rbfox2", "Tpm2", "Ryk", "Gpx8", "Pxdn", "Rcn1", "Fkbp9", 
                    "Kcna1", "Plp1", "Ank3", "Chl1", "Erbb3", "Aatk", "Kcna2", 
                    "Cadm4", "Art3", "Cdh19", "Gpm6b", "Cd59a", "Mal", "Cadm1", 
                    "Itgb8", "Atp1a2", "Ptn", "Gatm", "Cnp", "Cryab", "Vwa1", 
                    "Emp2", "Prnp", "Col16a1", "dtTomato", "tdTomato", "Lgi4", "Pou3f1", "Mbp", 
                    "Scn7a", "Dst", "Ckb", "Scd2", "Matn2", "Hspg2", "Gas7", 
                    "Fabp5", "Serpine2", "Abca8a"),
  
  "macrophages" = c("C1qc", "Mafb", "Csf1r", "Fcgr3", "Trem2", "Cx3cr1", "Tmem176a", "Cybb", 
                    "Fcgr1", "Adgre1", "Trf", "Lst1", "Itgb5", "Ms4a6d", "Clec4a3", "Tlr2", 
                    "Ccl9", "Cebpa", "Apobec1", "C3ar1", "Pla2g7", "Klra2", "Clec4a1", "Sirpa", 
                    "Cd68", "Itgam", "Clec4a2", "Lair1", "AI607873", "Ifi207", "Cyp4f18", "Ncf2", "C1qa", 
                    "Pid1", "Slc15a3", "Dab2", "Cxcl16", "Clec12a", "Lpcat2", "Hck", "Lrp1", 
                    "Ifngr2", "Ctsl", "Pirb", "Ccr1", "Lilrb4a", "Rassf4", "Ets2", "P2rx4", 
                    "Gngt2", "Syk", "Irf5"),
  
  "cDC" = c("Xcr1", "Itgae", "Cd24a", "Clec9a", "Tlr3", "Flt3", "Sept3", "Septin3", "Cldn1", 
            "Btla", "Ffar4", "Ifi205", "Hepacam2", "Gcsam", "Mycl", "P2ry14", "Wdfy4", 
            "Anpep", "H2-Ob", "Mctp1", "Ece1", "Slamf7", "Shtn1", "Kit", "Rab7b", 
            "Pkib", "Cbfa2t3", "Qpct", "Tbc1d8", "Batf3", "Naga", "H2-Oa", "Ppm1m", 
            "Dpp4", "Rnase6", "Sdad1", "BC028528", "Pak1", "Fgd2", "Tbc1d9", "Pbx1", 
            "Rab32", "Slc25a20", "Fchsd2", "Klrb1b", "Gm6377", "Slamf8", "Erlin1", "Trim35", 
            "Slc8b1", "Bri3bp", "Havcr2", "Olfm1", "Cdk14", "Acvrl1", "Arsb", "Ciita", 
            "Mnda", "Ifi211", "Pafah1b3", "Prkar2a", "Grasp", "Tamalin", "Arhgap5", "Napsa", "March1", "Marchf1", "Gng12", 
            "Ppfia4", "Klrk1"),
  
  "mDC" = c("Cd209a", "Mgl2", "Tnip3", "Mcemp1", "Cfp", "Olfm1", "Wfdc17", "Itgax", 
            "Slamf9", "Napsa", "Alcam", "Spint1", "Cbfa2t3", "Eps8", "Ciita", "Fgr", 
            "Cd300a", "Pkib", "Cysltr1", "Tep1", "Pak1", "Gpr35", "Ms4a4c", "Scimp", 
            "Naga"),
  
  "pDC" = c("Ly6d", "Cox6a2", "Ccr9", "Dntt", "Klk1", 
            "D13Ertd608e", "Spib", "Upb1", "Cd300c", "Sh3bgr", 
            "Paqr5", "Atp2a1", "Pir", "Siglech", "Smim5", 
            "Lefty1", "Klra17", "Atp1b1", "Lrrc16a", "Carmil1", "Cdh5", 
            "Fcrla", "Pacsin1", "Mctp2", "Spns3", "Bcl11a", 
            "Cmah", "Il7r", "Tex2", "Gm5547", "Hpse", 
            "Blnk", "Cxxc5", "P2ry14", "Dirc2", "Slc49a4", "Rell1", 
            "Sell", "Eepd1", "Runx2", "Ly6c2", "Ddr1", 
            "Nucb2", "Kmo", "Rnase6", "Tbc1d8", "Pltp", 
            "Sla2", "Flt3", "Plac8", "Csf2rb2", "Lifr", 
            "Abhd17b", "Hvcn1", "Prkca", "Clec10a", "Tmem229b", 
            "Tsc22d1", "Pafah1b3", "Rpgrip1", "Sqle", "Lag3", 
            "Plekhm3", "Slc44a2", "Traf4", "Nceh1", "Cdkn2d", 
            "5430427O19Rik", "Tasl", "Net1", "Msmo1", "Tubgcp5", "Dclre1c", 
            "Atp2b4", "Khk", "Ptprs", "Idi1", "Napsa", 
            "Card11", "Scpep1", "5730508B09Rik", "Fam241a", "Jakmip1", "Tifa", 
            "Clec2i", "Man2a2", "Cd7", "Dctn6", "Fdps", 
            "Ctse", "Gpr137b", "Spint2", "Edem2", "Fgr", 
            "Slamf9", "Gna15", "Klrd1", "Pkig", "Cd38", 
            "Ostm1", "Creld2", "Srebf2", "Slc35c2"),
  
  "T cells" = c("Cd3g", "Nkg7", "Cd3d", "Cd3e", "Cd8a", "Cxcr6", "Ms4a4b", "Ptprcap",
                "Gimap4", "Gimap3", "Sh2d2a", "Cd28", "Cd2", "Lck", "Lat", "Bcl11b", 
                "Thy1", "Gimap6", "Itk", "Gimap1", "Skap1", "Il2rb", "Ctsw", "Rhoh", 
                "Sept1", "Septin1", "Ctla2a"),
  
  "NK cells" = c("Klrb1c", "Ncr1", "Klra7", "Klrb1f", "Styk1", "Xcl1", "Klre1", "Klrc2", 
                 "Car2", "Samd3", "Spry2", "Satb1", "Klrk1", "Klrd1", "Txk", "Ctla2b", 
                 "Serpinb9", "Cst7", "Gem", "Eomes", "Cd244", "Cd244a", "Stat4", "Fasl", "Gimap5"),
  
  "neutrophils" = c("S100a9", "S100a8", "Hdc", "Cxcr2", "Csf3r", "Il1r2", "Trem1", "Clec4e", 
                    "Ptgs2", "Gsr", "Cd24a", "Cyp4f18", "Retnlg"),
  
  "mast cells" = c("Mrgprx2", "Tpsb2", "Tpsab1", "Mrgprb1", "Mcpt4", "Mrgprb2", "Fcer1a", 
                   "Cpa3", "Slc6a4", "Cma1", "Kit", "Rab27b", "Gata2", "Il1rl1", 
                   "Hdc", "Serpinb1a", "Lat2", "Vwa5a", "Ccl7", "Tmem64", "Basp1", 
                   "Ccl2", "Lilr4b", "ENSMUSG00000089672", "Gch1", "Fnip1", "Lilrb4a"),
  
  "B cells" = c("Cd79a", "Ly6d", "Ms4a1", "Bank1", "Fcmr", "Ccr7", "Cd79b", "H2-Ob", 
                "Bcl11a", "Gimap6", "H2-Oa", "Ptprcap", "Cd37", "H2-DMb2", "Ltb", "Ebf1", 
                "Scd1", "Napsa", "Gm26740", "Cytip", "Rel", "Pou2f2"),
  
  "endothelial cells" = c("Egfl7", "Cdh5", "Emcn", "Cd34", "Esam", "Plvap", "Aplnr", "Ramp2", 
                          "Tshz2", "Sox18", "Ecscr", "Cav1", "Adgrf5", "Ptprb", "Rasip1", "Tie1", 
                          "Kdr", "Cyyr1", "Mmrn2", "Grrp1", "Fam110d", "Flt1", "Arhgap29", "Lrg1", "Sparcl1", 
                          "Vwf", "Kank3", "Aqp1", "Col4a2", "Col4a1", "Nfib", "Eng", "Mast4", 
                          "S100a16", "Crip2", "Pecam1", "Abcg2", "Cd200", "Apbb2", "Hspg2", "Gng11", 
                          "Igfbp7", "Prkcdbp", "Cavin3", "Mcam", "Tm4sf1", "Pdlim1", "Insr", "Smad1", "Cd93", 
                          "Plekhg1", "Serpinh1", "Sparc", "Igfbp4", "Ppic", "Plxnd1", "Col18a1", "Sox4", 
                          "Timp3", "Snrk", "Dst", "Emp1"),
  
  "fibroblasts" = c("Mfap5", "Lum", "Fbln1", "Serping1", "Cilp", "Aspn", "Cdh11", 
                    "Mfap4", "Ccdc80", "Svep1", "Lox", "Il33", "Loxl1", "Cpxm1", 
                    "Mfap2", "Fbn2", "Islr", "C1s1", "Cpxm2", "Clec11a", "Fndc1", 
                    "Cd248", "Pdpn", "Slit3", "Fibin", "Colec12", "Twist1", "Pdgfrl", 
                    "Gxylt2", "Pdgfra", "Igsf10", "Cthrc1", "Bicc1", "Snhg18", "Fkbp11", 
                    "Ctsk", "Dcn", "Adamts2", "Fzd2", "Mmp23", "Mdk", "Smoc2", 
                    "Scarf2", "Ebf1", "Kdelr3", "Fbn1", "Igf1", "C1ra", "Gpx3", 
                    "Mrc2", "P3h3", "Mgp", "Pcolce", "Cdc42ep5", "Zfhx4", "Col12a1", 
                    "Col14a1", "Prrx1", "Rbp1", "Rhoj", "Lhfp", "Gpx8", "Col8a1", 
                    "Mxra8", "Col6a2", "Efemp2", "Col6a3", "Scn7a", "Apod", "Fzd1", 
                    "Lpar1", "Dpysl3", "Plpp3", "Fkbp7", "Aebp1", "Slit2", "Palld", 
                    "Bmp1", "Igfbp6", "Fstl1", "Gas6", "Fkbp10", "Maged2", "Crtap", 
                    "Rbms3", "Col5a1", "Plod2", "Oaf", "Mmp2", "Grb10", "Copz2", 
                    "Serpinf1", "Plat", "Timp1", "Fkbp9", "Col5a3", "S100a16", "Rab34", 
                    "Serf1", "Thbs2", "Npdc1", "Matn2", "Fam114a1", "Fscn1", "Meg3", 
                    "Mgst1", "Ecm1", "Col16a1", "Ddah2"),
  
  "mural cells" = c("Des", "Myh11", "Ano1", "Ndufa4l2", "Rgs5", "Notch3", "Gucy1a3", "Gucy1a1", "Pde3a", 
                    "Mylk", "Tpm2", "Nrarp", "Apold1", "Zak", "Map3k20", "Gm13889", "Tinagl1", "Myl9", 
                    "Arhgef17", "Usp2", "Rasd1", "Myo1b", "Aspn", "Mustn1", "S1pr3", "Ptp4a3", 
                    "Slc25a25", "Pdgfrb", "Ppp1r12b", "Rasl11a", "Rbpms", "Mfge8", "Adamts9", "Mgst3", 
                    "Rasgrp2", "Rrad", "Gng11", "Crispld2", "Tpm1", "Epas1", "Mprip", "Hspb1", 
                    "Zfhx3", "Bicd2", "Syne2", "Cwc25", "Crtc3", "Nolc1", "Lpp", "Dlc1", 
                    "Mapre2", "Cygb", "Mafk", "Nudt4", "Tns1", "Irs2", "Thy1", "Cpe", 
                    "Rbm4b", "Fbxo33", "Arhgef12"),
  
  "skeletal muscle cells" = c("Pgam2", "Apobec2", "Smpx", "Car3", "Tcap", "Cox8b", "Myoz1", "Eef1a2", 
                              "Pdlim3", "Des", "Klhl41", "Mb", "Atp2a1", "Fabp3", "Hspb6", "Myl1", 
                              "Ckm", "Cox6a2", "Chchd10", "Rpl3l", "Mylpf", "Ttn", "Eno3", "Tnnt3", 
                              "Jsrp1", "Tnnc2", "Tnni2", "Neb", "Acta1", "Tpm2", "Mustn1", "Cox7a1", 
                              "Tcea3", "Fhl1", "Tuba4a", "Ptp4a3", "Cystm1", "Adssl1", "Acyp2", "Scn1b", 
                              "Ndrg2", "Hspb1"))

lengths(cell_markers)
```


Here are custom colors for each cell type :

```{r color_markers, fig.width = 8, fig.height = 0.8, class.source = "fold-hide"}
color_markers = list("tumor cells" = "#DA2328",
                     "macrophages" = "#6ECEDF",
                     "cDC" = "#2995C6",
                     "mDC" = "#646EB3",
                     "pDC" = "#32B9A3",
                     "T cells" = "#7E2681",
                     "NK cells" = "#030303",
                     "neutrophils" = "#FDA31F",
                     "mast cells" = "#D9906B",
                     "B cells" = "#00797A",
                     "endothelial cells" = "#DEC422",
                     "fibroblasts" = "#2FB35B",
                     "mural cells" = "#AB5E30",
                     "skeletal muscle cells" = "#F46FB7")
color_markers = color_markers[names(color_markers) %in% names(cell_markers)]
cell_markers = cell_markers[names(color_markers)] # re-order

data.frame(cell_type = names(color_markers),
           color = unlist(color_markers)) %>%
  ggplot2::ggplot(., aes(x = cell_type, y = 0, fill = cell_type)) +
  ggplot2::geom_point(pch = 21, size = 5) +
  ggplot2::scale_fill_manual(values = unlist(color_markers), breaks = names(color_markers)) +
  ggplot2::theme_classic() +
  ggplot2::theme(legend.position = "none",
                 axis.line = element_blank(),
                 axis.title = element_blank(),
                 axis.ticks = element_blank(),
                 axis.text.y = element_blank(),
                 axis.text.x = element_text(angle = 10))
```

These are some markers to assess cell type annotation :

```{r dotplot_markers}
dotplot_markers = list(
  "tumor cells" = c("dtTomato", "Plp1", "Sox10", "Sox9", "Pdgfra"),
  "macrophages" = c("Lyz2", "Adgre1"),
  "cDC" = c("Xcr1", "Itgae"),
  "mDC" = c("Cd209a", "Mgl2"),
  "pDC" = c("Ly6d", "Siglech"),
  "T cells" = c("Cd3e", "Cd8a", "Cd4"),
  "NK cells" = c("Klrb1c", "Ncr1"),
  "neutrophils" = c("S100a9", "Retnlg"),
  "mast cells" = c("Tpsb2", "Kit"),
  "B cells" = c("Cd79a", "Cd19"),
  "endothelial cells" = c("Egfl7", "Pecam1"),
  "fibroblasts" = c("Mfap5", "Lum"),
  "mural cells" = c("Notch3", "Rgs5"),
  "skeletal muscle cells" = c("Tnnt3", "Myl1"))

lengths(dotplot_markers)
```

We save them :

```{r save_annotation}
saveRDS(color_markers, file = paste0(out_dir, "/", save_name, "_color_markers.rds"))
saveRDS(cell_markers, file = paste0(out_dir, "/", save_name, "_cell_markers.rds"))
saveRDS(dotplot_markers, file = paste0(out_dir, "/", save_name, "_dotplot_markers.rds"))
```


# R Session

```{r sessioninfo, echo = FALSE, fold_output = TRUE}
sessionInfo()
```